var d=class i{constructor(t=0,e=0){this.x=t;this.y=e}clone(){return new i(this.x,this.y)}add(t){return new i(this.x+t.x,this.y+t.y)}sub(t){return new i(this.x-t.x,this.y-t.y)}scale(t,e=t){return new i(this.x*t,this.y*e)}dot(t){return this.x*t.x+this.y*t.y}perp(){return new i(-this.y,this.x)}len(){return Math.hypot(this.x,this.y)}norm(){let t=this.len()||1;return new i(this.x/t,this.y/t)}rotate(t,e=null){let n=Math.cos(t),r=Math.sin(t),s=this.x,o=this.y;e&&(s-=e.x,o-=e.y);let a=s*n-o*r,f=s*r+o*n;return e?new i(a+e.x,f+e.y):new i(a,f)}toArray(){return[this.x,this.y]}static fromArray(t){return new i(t[0],t[1])}static lerp(t,e,n){return new i(t.x+(e.x-t.x)*n,t.y+(e.y-t.y)*n)}};function F(i,t,e=1e-9){if(!isFinite(i)||!isFinite(t))return[0,1];if(t-i<e){let n=(i+t)/2;return[n-e,n+e]}return[i,t]}var E=class{constructor(t,e=null,n=null,r="none"){this.app=t,this._viewport=n||{x:0,y:0,width:t.size.x,height:t.size.y},this.preserveAspect=r,this.worldBounds=e||{xMin:0,xMax:1,yMin:0,yMax:1},this.xTicks=[],this.yTicks=[],this.updateWorld(this.worldBounds)}get viewport(){return typeof this._viewport=="function"?this._viewport(this.app):this._viewport}aspectMode(){if(this.preserveAspect===!0)return"square";if(!this.preserveAspect||this.preserveAspect==="none")return"none";let t=String(this.preserveAspect).toLowerCase();return t==="square"?"square":t==="fit"?"fit":"none"}get scale(){let{xMin:t,xMax:e,yMin:n,yMax:r}=this.worldBounds,s=e-t,o=r-n,a=this.viewport;if(this.aspectMode()==="none")return new d(a.width/s,a.height/o);let c=a.width/s,u=a.height/o,h=Math.min(c,u);return new d(h,h)}worldToCanvas(t,e){let{xMin:n,xMax:r,yMin:s,yMax:o}=this.worldBounds,a=this.viewport,f=r-n,c=o-s;if(this.aspectMode()!=="none"){let h=this.scale.x,l=h*f,m=h*c,b=a.x+(a.width-l)/2,x=a.y+(a.height-m)/2,p=b+(t-n)*h,y=x+(o-e)*h;return new d(p,y)}else{let h=this.scale,l=a.x+(t-n)*h.x,m=a.y+(o-e)*h.y;return new d(l,m)}}canvasToWorld(t,e){let{xMin:n,xMax:r,yMin:s,yMax:o}=this.worldBounds,a=this.viewport,f=r-n,c=o-s;if(this.aspectMode()!=="none"){let h=this.scale.x,l=h*f,m=h*c,b=a.x+(a.width-l)/2,x=a.y+(a.height-m)/2,p=n+(t-b)/h,y=o-(e-x)/h;return new d(p,y)}else{let h=this.scale,l=n+(t-a.x)/h.x,m=o-(e-a.y)/h.y;return new d(l,m)}}unitsToPixels(t){return t*this.scale.x}updateWorld(t=null,e=10){if(t){let[a,f]=F(t.xMin,t.xMax),[c,u]=F(t.yMin,t.yMax);this.worldBounds={xMin:a,xMax:f,yMin:c,yMax:u}}let{xMin:n,xMax:r,yMin:s,yMax:o}=this.worldBounds;this.xTicks=this.computeTicks(n,r,e),this.yTicks=this.computeTicks(s,o,e)}computeTicks(t,e,n){if(!isFinite(t)||!isFinite(e)||n<=0)return[];if(Math.abs(e-t)<1e-12)return[t];let r=(e-t)/n,s=this.nicify(r);if(!isFinite(s)||s<=0)return[t,e];let o=Math.ceil(t/s)*s,a=[],f=Math.ceil((e-o)/s);for(let c=0;c<=f;c++){let u=o+c*s;a.push(+u.toFixed(10))}return a}nicify(t){if(!isFinite(t)||t<=0)return 1;let e=Math.floor(Math.log10(t)),n=t/Math.pow(10,e),r;return n<1.5?r=1:n<3?r=2:n<7?r=5:r=10,r*Math.pow(10,e)}fitToBounds(t,e=.05){if(!t||t.length===0)return;let n=1/0,r=-1/0,s=1/0,o=-1/0;for(let l of t)l&&(n=Math.min(n,l.xMin),r=Math.max(r,l.xMax),s=Math.min(s,l.yMin),o=Math.max(o,l.yMax));if(!isFinite(n)||!isFinite(r)||!isFinite(s)||!isFinite(o))return;[n,r]=F(n,r),[s,o]=F(s,o);let a=r-n,f=o-s,c=e<1?a*e:e,u=e<1?f*e:e;n=n-c,r=r+c,s=s-u,o=o+u;let h=this.aspectMode();if(h==="square"){let l=r-n,m=o-s,b=Math.max(l,m),x=(n+r)/2,p=(s+o)/2;n=x-b/2,r=x+b/2,s=p-b/2,o=p+b/2}else if(h==="fit")try{let l=this.viewport,m=l.width/Math.max(1,l.height);if((r-n)/Math.max(1e-12,o-s)>m){let x=(r-n)/m,p=(s+o)/2;s=p-x/2,o=p+x/2}else{let x=(o-s)*m,p=(n+r)/2;n=p-x/2,r=p+x/2}}catch{}this.worldBounds={xMin:n,xMax:r,yMin:s,yMax:o},this.updateWorld(this.worldBounds)}};function dt(i,t=30){let e=i.getBoundingClientRect();return{x:t,y:t,width:e.width-2*t,height:e.height-2*t}}function X(i){try{if(i==null)return null;if(Array.isArray(i.data)&&i.data.length){let t=i.data.map(n=>n.x),e=i.data.map(n=>n.y);return{xMin:Math.min(...t),xMax:Math.max(...t),yMin:Math.min(...e),yMax:Math.max(...e)}}else if(Array.isArray(i.points)&&i.points.length){let t=i.points.map(n=>n.x),e=i.points.map(n=>n.y);return{xMin:Math.min(...t),xMax:Math.max(...t),yMin:Math.min(...e),yMax:Math.max(...e)}}else if(i.pos){let t=i.pos.x,e=i.pos.x,n=i.pos.y,r=i.pos.y;return typeof i.radius=="number"&&(t=i.pos.x-i.radius,e=i.pos.x+i.radius,n=i.pos.y-i.radius,r=i.pos.y+i.radius),{xMin:t,xMax:e,yMin:n,yMax:r}}else if(i.p1&&i.p2){let t=[i.p1.x,i.p2.x],e=[i.p1.y,i.p2.y];return{xMin:Math.min(...t),xMax:Math.max(...t),yMin:Math.min(...e),yMax:Math.max(...e)}}else{if(i.grid)return{xMin:0,xMax:(i.grid[0]||[]).length,yMin:0,yMax:i.grid.length};if(i.bounds&&isFinite(i.bounds.xMin)&&isFinite(i.bounds.xMax)&&isFinite(i.bounds.yMin)&&isFinite(i.bounds.yMax))return i.bounds}}catch{}return null}function gt(i,t,e=.05){let n=t.map(X).filter(r=>r!=null);n.length&&i.fitToBounds(n,e)}var k=Object.freeze({black:[0,0,0,255],white:[255,255,255,255],red:[255,0,0,255],green:[0,255,0,255],blue:[0,0,255,255],yellow:[255,255,0,255],cyan:[0,255,255,255],magenta:[255,0,255,255],gray:[128,128,128,255],grey:[128,128,128,255],orange:[255,165,0,255],transparent:[0,0,0,0]});function q(i){return i<0?0:i>255?255:i|0}function xt(i){return i<0?0:i>1?1:i}function v(i){if(Array.isArray(i)){let[e,n,r,s=255]=i;return[e|0,n|0,r|0,s|0]}if(typeof i!="string")return null;let t=i.trim().toLowerCase();if(t in k)return k[t];if(t[0]==="#"){let e=t.slice(1),n=e.length,r=s=>parseInt(e[s]+(n<6?e[s]:e[s+1]||e[s]),16);switch(n){case 3:return[r(0),r(1),r(2),255];case 4:return[r(0),r(1),r(2),r(3)];case 6:return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16),255];case 8:return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16),parseInt(e.slice(6,8),16)];default:return null}}if(t.startsWith("rgb")){let e=t.match(/\d+\.?\d*/g);if(!e||e.length!==3&&e.length!==4)return null;let n=q(+e[0]),r=q(+e[1]),s=q(+e[2]),o=e[3]==null?255:xt(+e[3])*255+.5|0;return[n,r,s,o]}return null}function K(i,t,e,n){return n<<24|e<<16|t<<8|i}function vt(i){return[i&255,i>>>8&255,i>>>16&255,i>>>24&255]}function I(i,t,e,n,r,s,o,a){let f=n/255,c=a/255,u=c+f*(1-c);if(u<=0)return[0,0,0,0];let h=1-c,l=(r*c+i*f*h)/u,m=(s*c+t*f*h)/u,b=(o*c+e*f*h)/u;return[l,m,b,u*255]}function Ct(i){if(Array.isArray(i)){let t=i;return[t[0]|0,t[1]|0,t[2]|0,(t[3]??255)|0]}else return v(i)||k.white}function G(i,t,e,n){let r=n,s=Math.round(t.x),o=Math.round(t.y),a=Math.round(e.x),f=Math.round(e.y),c=Math.abs(a-s),u=Math.abs(f-o),h=s<a?1:-1,l=o<f?1:-1,m=c-u,b=i.buffer;for(;b.putPixelBlend(s,o,r),!(s===a&&o===f);){let x=m<<1;x>-u&&(m-=u,s+=h),x<c&&(m+=c,o+=l)}}function J(i,t,e,{type:n="circle",size:r=3}={}){if(n==="circle")A(i,t,r,e);else if(n==="cross")G(i,new d(t.x-r,t.y),new d(t.x+r,t.y),e),G(i,new d(t.x,t.y-r),new d(t.x,t.y+r),e);else if(n==="square"){let s=r|0,o=[new d(t.x-s,t.y-s),new d(t.x+s,t.y-s),new d(t.x+s,t.y+s),new d(t.x-s,t.y+s)];z(i,o,e,1)}}function z(i,t,e,n=1){for(let r=0;r<t.length;r++){let s=t[r],o=t[(r+1)%t.length];if(n<=1){G(i,s,o,e);continue}let a=o.sub(s),f=a.len()||1,c=a.scale(1/f),u=new d(-c.y,c.x),h=n/2|0;for(let l=-h;l<=h;l++){let m=u.scale(l);G(i,s.add(m),o.add(m),e)}}}function A(i,t,e,n){let r=e*e,s=Math.max(0,Math.floor(t.x)|0),o=Math.min(i.buffer.width-1,Math.ceil(t.x)|0),a=Math.max(0,Math.floor(t.y)|0),f=Math.min(i.buffer.height-1,Math.ceil(t.y)|0),c=i.buffer.pixels,u=i.buffer.width;for(let h=a;h<=f;h++){let l=h-t.y,m=l*l,b=(h*u+s|0)*4;for(let x=s;x<=o;x++,b+=4){let p=x-t.x;if(p*p+m<=r){let y=c[b],w=c[b+1],g=c[b+2],V=c[b+3],[B,D,S,L]=I(y,w,g,V,n[0],n[1],n[2],n[3]);c[b]=B+.5|0,c[b+1]=D+.5|0,c[b+2]=S+.5|0,c[b+3]=L+.5|0}}}}function R(i,t,e){let n=t?.length|0;if(n<3)return;let r=i.buffer.height|0,s=i.buffer.width|0,o=1/0,a=-1/0,f=[];for(let u=0;u<n;u++){let h=t[u],l=t[(u+1)%n],m=h.x,b=h.y,x=l.x,p=l.y;if(b===p)continue;let y=Math.min(b,p),w=Math.max(b,p),g=b<p?m:x,V=(x-m)/(p-b);f.push({ymin:y,ymax:w,x:g,invSlope:V}),y<o&&(o=y),w>a&&(a=w)}o=Math.max(0,Math.floor(o)|0),a=Math.min(r-1,Math.ceil(a)|0);let c=i.buffer.pixels;for(let u=o;u<=a;u++){let h=[];for(let l of f)u>=l.ymin&&u<l.ymax&&h.push(l.x+(u-l.ymin)*l.invSlope);if(h.length){h.sort((l,m)=>l-m);for(let l=0;l<h.length;l+=2){let m=Math.max(0,Math.floor(h[l])|0),b=Math.min(s-1,Math.ceil(h[l+1])|0),x=(u*s+m|0)*4;for(let p=m;p<=b;p++,x+=4){let y=c[x],w=c[x+1],g=c[x+2],V=c[x+3],[B,D,S,L]=I(y,w,g,V,e[0],e[1],e[2],e[3]);c[x]=B+.5|0,c[x+1]=D+.5|0,c[x+2]=S+.5|0,c[x+3]=L+.5|0}}}}}var C=(i,t,e,n,r=1)=>z(i,[t,e],n,r);function Q(i,t,e,n,r=1,s=32){let o=[];for(let a=0;a<s;a++){let f=a/s*Math.PI*2;o.push(new d(t.x+e*Math.cos(f),t.y+e*Math.sin(f)))}z(i,o,n,r)}function _(i){if(!isFinite(i)||i<=0)return 0;let t=Math.abs(i);return t>=1?0:Math.min(6,Math.ceil(-Math.log10(t)))}function tt(i,t){let e=+i.toFixed(t);return(Math.abs(e)<1e-12?0:e).toFixed(t)}var et=class{constructor(t,e={}){this.vp=t;this.showGrid=e.showGrid!==!1,this.showAxes=e.showAxes!==!1,this.showTicks=e.showTicks!==!1,this.drawBorder=e.drawBorder||!1,this.axisAtZero=e.axisAtZero!==!1,this.gridColor=v(e.gridColor||"#2a2a2a"),this.axisColor=v(e.axisColor||"#888"),this.borderColor=v(e.borderColor||"#555"),this.tickSizePx=e.tickSizePx??6,this.tickThickness=e.tickThickness??1,this.axisThickness=e.axisThickness??2,this.font=e.font||"12px sans-serif",this.textColor=e.textColor||"#fff",this.margin=e.margin??30,this.labelOffset=e.labelOffset??10,this.numTicksX=e.numTicksX??5,this.numTicksY=e.numTicksY??5,this.autoScale=e.autoScale??!1,this.axisXPos=0,this.axisYPos=0}setAxisPosition(t,e){this.axisXPos=t,this.axisYPos=e}setLabelStyle(t,e,n){this.font=t,this.textColor=e,n!==void 0&&(this.labelOffset=n)}computeTicks(t,e,n){if(!isFinite(t)||!isFinite(e)||n<=0)return[];let r=e-t;if(r===0)return[t];let s=r/n,o=Math.pow(10,Math.floor(Math.log10(s))),a=Math.ceil(s/o)*o,f=Math.ceil(t/a)*a,c=[];for(let u=f;u<=e+1e-12;u+=a)c.push(+u.toFixed(6));return c}autoScaleTicks(){if(!this.autoScale)return;let t=this.vp.worldBounds,e=Math.abs(t.xMax-t.xMin),n=Math.abs(t.yMax-t.yMin);e>0&&(this.numTicksX=Math.max(2,Math.floor(this.vp.viewport.width/80))),n>0&&(this.numTicksY=Math.max(2,Math.floor(this.vp.viewport.height/80)))}autoScaleToDrawables(t,e=.05){let n=t.map(X).filter(r=>r!=null);n.length&&this.vp.fitToBounds(n,e)}draw(t){let e=this.vp.viewport,n=this.vp.worldBounds;if(!e||!n)return;this.autoScale&&this.autoScaleTicks();let r=this.computeTicks(n.xMin,n.xMax,this.numTicksX),s=this.computeTicks(n.yMin,n.yMax,this.numTicksY),o=_(r.length>1?Math.abs(r[1]-r[0]):1),a=_(s.length>1?Math.abs(s[1]-s[0]):1),f=this.axisAtZero&&n.yMin<=0&&n.yMax>=0?this.axisXPos:n.yMin,c=this.axisAtZero&&n.xMin<=0&&n.xMax>=0?this.axisYPos:n.xMin;if(this.showGrid){for(let u of r){let h=this.vp.worldToCanvas(u,n.yMin),l=this.vp.worldToCanvas(u,n.yMax);C(t,h,l,this.gridColor,1)}for(let u of s){let h=this.vp.worldToCanvas(n.xMin,u),l=this.vp.worldToCanvas(n.xMax,u);C(t,h,l,this.gridColor,1)}}if(this.showAxes){let u=this.vp.worldToCanvas(n.xMin,f),h=this.vp.worldToCanvas(n.xMax,f),l=this.vp.worldToCanvas(c,n.yMin),m=this.vp.worldToCanvas(c,n.yMax);C(t,u,h,this.axisColor,this.axisThickness),C(t,l,m,this.axisColor,this.axisThickness)}if(this.showTicks&&this.tickSizePx>0){let u=this.tickSizePx;for(let h of r){let l=this.vp.worldToCanvas(h,f);C(t,new d(l.x,l.y-u/2),new d(l.x,l.y+u/2),this.axisColor,this.tickThickness),t.drawText(tt(h,o),new d(l.x,l.y+this.labelOffset),this.textColor,this.font,"center","top")}for(let h of s){let l=this.vp.worldToCanvas(c,h);C(t,new d(l.x-u/2,l.y),new d(l.x+u/2,l.y),this.axisColor,this.tickThickness),t.drawText(tt(h,a),new d(l.x-this.labelOffset,l.y),this.textColor,this.font,"right","middle")}}}};var M=class i{constructor(t=1,e=0,n=0,r=1,s=0,o=0){this.a=t;this.b=e;this.c=n;this.d=r;this.e=s;this.f=o}static identity(){return new i}static translation(t,e){return new i(1,0,0,1,t,e)}static scale(t,e=t){return new i(t,0,0,e,0,0)}static rotation(t){let e=Math.cos(t),n=Math.sin(t);return new i(e,n,-n,e,0,0)}static fromCanvasTransform(t,e,n,r,s,o){return new i(t,e,n,r,s,o)}multiply(t){return new i(this.a*t.a+this.c*t.b,this.b*t.a+this.d*t.b,this.a*t.c+this.c*t.d,this.b*t.c+this.d*t.d,this.a*t.e+this.c*t.f+this.e,this.b*t.e+this.d*t.f+this.f)}transformV2(t){return new d(this.a*t.x+this.c*t.y+this.e,this.b*t.x+this.d*t.y+this.f)}static around(t,e){return i.translation(t.x,t.y).multiply(e).multiply(i.translation(-t.x,-t.y))}};var T=class{constructor(t="white",e=!1,n=null,r=M.identity(),s){this.color=t;this.fill=e;this.fillColor=n;this.transform=r;this.fillColor||(this.fillColor=t),this.legend=s}parseColorSafe(t){return[...v(t)??[255,255,255,255]]}},nt=class extends T{constructor(e,n={}){super(n.color??"red",n.fill??!1,n.fillColor??"rgba(255,0,0,0.3)",M.identity(),n.legend);this.data=e;this.baselineY=n.baselineY??0}draw(e,n){if(!this.data?.length)return;let r=n.worldToCanvas(this.data[0].x,this.data[0].y),s=this.parseColorSafe(this.color);for(let c=1;c<this.data.length;c++){let u=n.worldToCanvas(this.data[c].x,this.data[c].y);C(e,r,u,s),r=u}if(!this.fill)return;let o=this.data.map(c=>n.worldToCanvas(c.x,c.y)),a=this.data[this.data.length-1],f=this.data[0];o.push(n.worldToCanvas(a.x,this.baselineY)),o.push(n.worldToCanvas(f.x,this.baselineY)),R(e,o,this.parseColorSafe(this.fillColor))}},rt=class extends T{constructor(e=new d(0,0),n=1,r={}){super(r.color??"white",r.fill??!1,r.fillColor??null,r.transform??M.identity(),r.legend);this.center=e;this.radius=n}draw(e,n){let r=this.transform.transformV2(this.center),s=n.worldToCanvas(r.x,r.y),o=n.scale,a=this.radius*(n.preserveAspect?o.x:(o.x+o.y)*.5);this.fill&&A(e,s,a,this.parseColorSafe(this.fillColor)),Q(e,s,a,this.parseColorSafe(this.color))}},it=class extends T{constructor(e,n,r={}){super(r.color??"yellow",!1,null,r.transform??M.identity(),r.legend);this.p1=e;this.p2=n;this.width=Math.max(1,(r.width??2)|0)}draw(e,n){let r=this.transform.transformV2(this.p1),s=this.transform.transformV2(this.p2),o=n.worldToCanvas(r.x,r.y),a=n.worldToCanvas(s.x,s.y);z(e,[o,a],this.parseColorSafe(this.color),this.width)}},st=class extends T{constructor(e,n={}){super(n.color??"white",!1,null,n.transform??M.identity(),n.legend);this.pos=e;this.type=n.type??"circle",this.size=n.size??3}draw(e,n){let r=this.transform.transformV2(this.pos),s=n.worldToCanvas(r.x,r.y);J(e,s,this.parseColorSafe(this.color),{type:this.type,size:this.size})}},ot=class extends T{constructor(t,e,n,r={}){super(r.color??"yellow",r.fill??!0,r.fillColor??"rgba(255,255,0,0.5)",r.transform??M.identity(),r.legend),this.points=[t,e,n]}draw(t,e){let r=this.points.map(s=>this.transform.transformV2(s)).map(s=>e.worldToCanvas(s.x,s.y));this.fill&&R(t,r,this.parseColorSafe(this.fillColor));for(let s=0;s<3;s++)C(t,r[s],r[(s+1)%3],this.parseColorSafe(this.color))}},at=class extends T{constructor(e,n,r={}){super(r.color??"white",!1,null,r.transform??M.identity(),r.legend);this.text=e;this.pos=n;this.font=r.font??"14px sans-serif",this.align=r.align??"left",this.baseline=r.baseline??"alphabetic"}draw(e,n){let r=this.transform.transformV2(this.pos),s=n.worldToCanvas(r.x,r.y);e.drawText(this.text,s,this.color,this.font,this.align,this.baseline)}},lt=class extends T{constructor(e,n,r={}){super(r.color??"white",!1,null,r.transform??M.identity(),r.legend);this.text=e;this.pos=n;this.mode=r.mode??"world",this.font=r.font??"14px sans-serif",this.align=r.align??"left",this.baseline=r.baseline??"alphabetic"}draw(e,n){let r=this.mode==="canvas"?this.pos:n.worldToCanvas(this.transform.transformV2(this.pos).x,this.transform.transformV2(this.pos).y);e.drawText(this.text,r,this.color,this.font,this.align,this.baseline)}};var O=class{constructor(t,e){this.width=0;this.height=0;this.imageData=new ImageData(Math.max(1,t|0),Math.max(1,e|0)),this.pixels=this.imageData.data,this.px32=new Uint32Array(this.pixels.buffer),this.width=this.imageData.width,this.height=this.imageData.height}resize(t,e){this.imageData=new ImageData(Math.max(1,t|0),Math.max(1,e|0)),this.pixels=this.imageData.data,this.px32=new Uint32Array(this.pixels.buffer),this.width=this.imageData.width,this.height=this.imageData.height}clear(t="#131313"){let e=v(t)||k.black,n=K(e[0],e[1],e[2],e[3]);this.px32.fill(n)}index(t,e){return(e*this.width+t|0)*4}putPixel(t,e,n){if(t>>>0>=this.width>>>0||e>>>0>=this.height>>>0)return;let r=this.index(t|0,e|0),s=n;this.pixels[r]=s[0],this.pixels[r+1]=s[1],this.pixels[r+2]=s[2],this.pixels[r+3]=s[3]}putPixelBlend(t,e,n){if(t>>>0>=this.width>>>0||e>>>0>=this.height>>>0)return;let r=this.index(t|0,e|0),s=this.pixels[r],o=this.pixels[r+1],a=this.pixels[r+2],f=this.pixels[r+3],[c,u,h,l]=I(s,o,a,f,n[0],n[1],n[2],n[3]);this.pixels[r]=c+.5|0,this.pixels[r+1]=u+.5|0,this.pixels[r+2]=h+.5|0,this.pixels[r+3]=l+.5|0}blit(t,e,n){let r=t.width|0,s=t.height|0,o=t.data,a=this.width,f=this.height;e|=0,n|=0;let c=Math.max(0,e),u=Math.max(0,n),h=Math.min(a,e+r),l=Math.min(f,n+s);for(let m=u-n;m<l-n;m++){let x=(n+m)*a;for(let p=c-e;p<h-e;p++){let y=e+p,w=(m*r+p)*4,g=(x+y)*4,V=this.pixels[g],B=this.pixels[g+1],D=this.pixels[g+2],S=this.pixels[g+3],L=o[w],mt=o[w+1],ft=o[w+2],N=o[w+3],P=N/255,Y=1-P;this.pixels[g]=L*P+V*Y+.5|0,this.pixels[g+1]=mt*P+B*Y+.5|0,this.pixels[g+2]=ft*P+D*Y+.5|0,this.pixels[g+3]=N*P+S*Y+.5|0}}}};var W=class{constructor(t=256){this.capacity=t;this.map=new Map;this.capacity|=0}get(t){let e=this.map.get(t);return e&&(this.map.delete(t),this.map.set(t,e)),e??null}set(t,e){for(this.map.has(t)&&this.map.delete(t),this.map.set(t,e);this.map.size>this.capacity;){let n=this.map.keys().next().value;n!==void 0&&this.map.delete(n)}}clear(){this.map.clear()}};var H=class{constructor(t){this.canvas=t;this.renderables=[];this.ctx=t.getContext("2d"),this.size=new d(t.width,t.height),this.buffer=new O(this.size.x,this.size.y),this.textCanvas=document.createElement("canvas"),this.textCtx=this.textCanvas.getContext("2d"),this.textCache=new W(512)}addRenderable(t){this.renderables.push(t)}clear(t="#131313"){this.buffer.clear(t)}putPixel(t,e){this.buffer.putPixel(t.x|0,t.y|0,e)}putPixelBlend(t,e){this.buffer.putPixelBlend(t.x|0,t.y|0,e)}blitImageData(t,e,n){this.buffer.blit(t,e,n)}render(){this.ctx.putImageData(this.buffer.imageData,0,0)}renderAll(){this.clear(),this.renderables.forEach(t=>t.draw(this)),this.render()}drawText(t,e,n="#fff",r="12px sans-serif",s="left",o="alphabetic"){let a=`${t}|${r}|${n}`,f=this.textCache.get(a);if(!f){let m=this.textCtx;m.font=r;let b=m.measureText(t),x=Math.ceil(b.width+4),p=Math.ceil((b.actualBoundingBoxAscent||10)+(b.actualBoundingBoxDescent||4)+4);(this.textCanvas.width<x||this.textCanvas.height<p)&&(this.textCanvas.width=x,this.textCanvas.height=p),m.clearRect(0,0,x,p),m.font=r,m.fillStyle=n,m.textBaseline="top",m.textAlign="left",m.fillText(t,2,2),f=m.getImageData(0,0,x,p),this.textCache.set(a,f)}let{width:c,height:u}=f,h=0,l=0;s==="center"?h=-c/2:(s==="right"||s==="end")&&(h=-c),o==="middle"?l=-u/2:(o==="bottom"||o==="ideographic"||o==="alphabetic")&&(l=-u),this.blitImageData(f,e.x+h+.5|0,e.y+l+.5|0)}},Z=class{constructor(t,e={}){this.containerDiv=t;this.canvas=document.createElement("canvas"),t.appendChild(this.canvas),Object.assign(this.canvas.style,{width:"100%",height:"100%",display:"block",background:e.background||"black"}),this.app=new H(this.canvas),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){let t=this.containerDiv.getBoundingClientRect(),e=window.devicePixelRatio||1,n=Math.max(1,t.width|0),r=Math.max(1,t.height|0);this.canvas.width=n*e,this.canvas.height=r*e,this.app.ctx.setTransform(1,0,0,1,0,0),this.app.ctx.scale(e,e),this.app.size=new d(n,r),this.app.buffer.resize(n,r)}clear(){this.app.clear()}render(){this.app.render()}};function bt(i,t,e){return i.rotate(e,t)}function _t(i,t,e){i.points=i.points.map(n=>bt(n,t,e))}function te(i,t,e){let n=M.around(t,M.scale(Math.cos(e),1));i.points=i.points.map(r=>n.transformV2(r))}function pt(i,t,e){return M.around(t,M.scale(Math.cos(e),1)).transformV2(i)}var j=class i{static findX(t){let e=[];for(let n=1;n<t.length;n++){let r=t[n-1].y,s=t[n].y;if(r===0)e.push(t[n-1].x);else if(r*s<0){let o=t[n-1].x,a=t[n].x;e.push(o+-r/(s-r)*(a-o))}}return e}static drawX(t,e,n,r="yellow"){let s=v(r)||k.yellow,o=i.findX(n);for(let a of o){let f=e.worldToCanvas(a,0);A(t,new d(f.x+.5|0,f.y+.5|0),5,s)}}};var ct=class{constructor(){this.layers=[]}add(t,e="default"){let n=Array.isArray(t)?t:[t],r=this.layers.find(s=>s.name===e);return r||(r={name:e,drawables:[]},this.layers.push(r),this.sortLayers()),r.drawables.push(...n),this}remove(t){for(let e of this.layers)e.drawables=e.drawables.filter(n=>n!==t);return this}clear(t){if(t){let e=this.layers.find(n=>n.name===t);e&&(e.drawables.length=0)}else this.layers.length=0;return this}draw(t,e){for(let r of this.layers)if(r.name!=="debug")for(let s of r.drawables)s.visible!==!1&&s.draw(t,e);let n=this.layers.find(r=>r.name==="debug");if(n)for(let r of n.drawables)r.visible!==!1&&(r.ignoreViewport?r.draw(t,void 0):r.draw(t,e))}collectDrawables(){let t=[];for(let e of this.layers)t.push(...e.drawables);return t}collectLegend(){let t=[];for(let e of this.layers)for(let n of e.drawables){let r=n.legend;r&&t.push({label:r.label,color:r.color??n.color??"#fff",symbol:r.symbol??"line"})}return t}sortLayers(){this.layers.sort((t,e)=>t.name==="debug"?1:e.name==="debug"?-1:t.name.localeCompare(e.name))}},ht=class{constructor(){this.entries=[];this._rafId=null}add(t,e,n,r){return this.entries.push({host:t,scene:e,vp:n,id:r}),this}init(){this.entries.forEach(({host:t,vp:e})=>{if(t.resize?.(),e?.updateWorld)try{e.updateWorld(e.worldBounds)}catch(n){console.warn("Could not update viewport:",n)}})}resizeAll(){this.entries.forEach(({host:t,vp:e})=>{if(t.resize?.(),e?.updateWorld)try{e.updateWorld(e.worldBounds)}catch{}})}renderAll(){this.entries.forEach(({host:t,scene:e,vp:n})=>{t.clear?.(),e.draw(t.app,n),t.render?.()})}startLoop(t){if(this._rafId!=null)return;let e=n=>{t?.(n),this.renderAll(),this._rafId=requestAnimationFrame(e)};this._rafId=requestAnimationFrame(e)}stopLoop(){this._rafId!=null&&(cancelAnimationFrame(this._rafId),this._rafId=null)}get(t){return this.entries.find(e=>e.id===t)}attachWindowResize(t=120){let e=null;window.addEventListener("resize",()=>{e!=null&&window.clearTimeout(e),e=window.setTimeout(()=>{this.resizeAll(),e=null},t)})}};var U=class{constructor(t,e,n="#fff",r="16px monospace"){this.text=t;this.pos=e;this.color=n;this.font=r}draw(t,e=2){let n=new d(this.pos.x+e,this.pos.y+e);t.drawText(this.text,n,this.color,this.font,"left","top")}},ut=class i extends T{constructor(e=new d(10,10),n=2){super("white",!1,null);this.elements=[];this.lastTime=performance.now();this.visible=!0;this.ignoreViewport=!0;this.margin=n;let r=new U("FPS: 0",e);this.elements.push(r),i.registry.push(this)}static{this.registry=[]}update(){let e=performance.now(),n=e-this.lastTime,r=n>0?Math.round(1e3/n):0;this.elements[0].text=`FPS: ${r}`,this.lastTime=e}draw(e){if(this.visible)for(let n of this.elements)n.draw(e,this.margin)}static updateAll(){for(let e of i.registry)e.update()}};var $=class extends T{constructor(e,n={}){super("white",!1,null);this.items=e;this.options=n}estimateTextWidth(e,n){let r=/(\d+)\s*px/.exec(n),s=r?parseInt(r[1],10):12;return Math.max(8,Math.round(e.length*s*.6))}draw(e,n){let r={anchor:this.options.anchor??"ne",padding:this.options.padding??8,gap:this.options.gap??6,swatchSize:this.options.swatchSize??14,font:this.options.font??"12px sans-serif",textColor:this.options.textColor??"#fff",background:this.options.background===void 0?"rgba(0,0,0,0.35)":this.options.background,boxOffset:this.options.boxOffset??new d(0,0),maxWidthPx:this.options.maxWidthPx??0};if(!this.items?.length)return;let s=n.viewport,o=r.padding,a=r.swatchSize,f=Math.max(a,12)+r.gap,c=0;for(let y of this.items)c=Math.max(c,this.estimateTextWidth(y.label,r.font));let u=a+6+c,h=(r.maxWidthPx&&r.maxWidthPx>u?r.maxWidthPx:u)+o*2,l=this.items.length*f-r.gap+o*2,m=0,b=0;switch(r.anchor){case"ne":m=s.x+s.width-h-4,b=s.y+4;break;case"nw":m=s.x+4,b=s.y+4;break;case"se":m=s.x+s.width-h-4,b=s.y+s.height-l-4;break;case"sw":m=s.x+4,b=s.y+s.height-l-4;break}if(m+=r.boxOffset.x,b+=r.boxOffset.y,r.background){let y=v(r.background)||[0,0,0,128],w=[new d(m,b),new d(m+h,b),new d(m+h,b+l),new d(m,b+l)];R(e,w,y)}let x=m+o,p=b+o+f/2;for(let y of this.items){let w=v(y.color)||[255,255,255,255],g=y.symbol??"line";if(g==="marker")A(e,new d(Math.round(x+a/2),Math.round(p)),Math.max(3,Math.floor(a/3)),w);else if(g==="area"){let V=[new d(x,p-a/2+3),new d(x+a,p-a/2+3),new d(x+a,p+a/2-3),new d(x,p+a/2-3)];R(e,V,w),C(e,new d(x,p-a/2),new d(x+a,p-a/2),w,1)}else C(e,new d(x,p),new d(x+a,p),w,2);e.drawText(y.label,new d(x+a+6,p),r.textColor,r.font,"left","middle"),p+=f}}};export{H as CanvasRenderer,ut as DebugUI,T as Drawable,rt as DrawableCircle,nt as DrawableFunction,lt as DrawableLabel,$ as DrawableLegend,it as DrawableLine,st as DrawablePoint,at as DrawableText,ot as DrawableTriangle,Z as DynamicCanvasRenderer,et as Graph,j as Intercepts,k as NAMED,O as PixelBuffer,ct as Scene,ht as SceneManager,W as TextCache,M as Transform2D,d as V2,E as ViewportManager,gt as autoScaleViewport,I as blendRGBA,xt as clamp01,q as clamp255,Q as drawCircleOutline,C as drawLine,A as fillCircle,R as fillPolygon,dt as getDivViewport,X as getDrawableBounds,K as packABGR,v as parseColor,pt as projectYRotation,G as rawLine,J as rawPoint,bt as rotatePoint,_t as rotateTriangleAroundCenter,te as rotateTriangleVertical,z as strokeShape,Ct as toColor,vt as unpackABGR};
//# sourceMappingURL=canvasLib.js.map
