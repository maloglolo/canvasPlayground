var d=class i{constructor(t=0,e=0){this.x=t;this.y=e}clone(){return new i(this.x,this.y)}add(t){return new i(this.x+t.x,this.y+t.y)}sub(t){return new i(this.x-t.x,this.y-t.y)}scale(t,e=t){return new i(this.x*t,this.y*e)}dot(t){return this.x*t.x+this.y*t.y}perp(){return new i(-this.y,this.x)}len(){return Math.hypot(this.x,this.y)}norm(){let t=this.len()||1;return new i(this.x/t,this.y/t)}rotate(t,e=null){let n=Math.cos(t),r=Math.sin(t),s=this.x,a=this.y;e&&(s-=e.x,a-=e.y);let o=s*n-a*r,x=s*r+a*n;return e?new i(o+e.x,x+e.y):new i(o,x)}toArray(){return[this.x,this.y]}static fromArray(t){return new i(t[0],t[1])}static lerp(t,e,n){return new i(t.x+(e.x-t.x)*n,t.y+(e.y-t.y)*n)}};var E=class{constructor(t,e=null,n=null,r="none"){this.app=t,this._viewport=n||{x:0,y:0,width:t.size.x,height:t.size.y},this.preserveAspect=r,this.worldBounds=e||{xMin:0,xMax:1,yMin:0,yMax:1},this.xTicks=[],this.yTicks=[],this.updateWorld(this.worldBounds)}get viewport(){return typeof this._viewport=="function"?this._viewport(this.app):this._viewport}get scale(){let{xMin:t,xMax:e,yMin:n,yMax:r}=this.worldBounds,s=e-t,a=r-n,o=this.viewport;if(!this.preserveAspect||this.preserveAspect==="none")return new d(o.width/s,o.height/a);let x=o.width/o.height,c=s/a,l=x>c?o.height/a:o.width/s;return new d(l,l)}worldToCanvas(t,e){let{xMin:n,xMax:r,yMin:s,yMax:a}=this.worldBounds,o=this.viewport,x=r-n,c=a-s;if(this.preserveAspect&&this.preserveAspect!=="none"){let l=this.scale.x,u=l*x,h=l*c,m=o.x+(o.width-u)/2,b=o.y+(o.height-h)/2;return new d(m+(t-n)*l,b+(c-(e-s))*l)}else{let l=this.scale;return new d(o.x+(t-n)*l.x,o.y+(a-e)*l.y)}}canvasToWorld(t,e){let{xMin:n,xMax:r,yMin:s,yMax:a}=this.worldBounds,o=this.viewport,x=r-n,c=a-s;if(this.preserveAspect&&this.preserveAspect!=="none"){let l=this.scale.x,u=l*x,h=l*c,m=o.x+(o.width-u)/2,b=o.y+(o.height-h)/2;return new d(n+(t-m)/l,a-(e-b)/l)}else{let l=this.scale;return new d(n+(t-o.x)/l.x,a-(e-o.y)/l.y)}}unitsToPixels(t){return t*this.scale.x}updateWorld(t=null,e=10){t&&(this.worldBounds=t);let{xMin:n,xMax:r,yMin:s,yMax:a}=this.worldBounds;this.xTicks=this.computeTicks(n,r,e),this.yTicks=this.computeTicks(s,a,e)}computeTicks(t,e,n){let r=this.nicify((e-t)/n),s=Math.ceil(t/r)*r,a=[];for(let o=s;o<=e;o+=r)a.push(+o.toFixed(10));return a}nicify(t){let e=Math.floor(Math.log10(t)),n=t/Math.pow(10,e),r;return n<1.5?r=1:n<3?r=2:n<7?r=5:r=10,r*Math.pow(10,e)}fitToBounds(t,e=.05){if(!t||t.length===0)return;let n=1/0,r=-1/0,s=1/0,a=-1/0;for(let u of t)n=Math.min(n,u.xMin),r=Math.max(r,u.xMax),s=Math.min(s,u.yMin),a=Math.max(a,u.yMax);let o=r-n||1,x=a-s||1,c=e<1?o*e:e,l=e<1?x*e:e;this.worldBounds={xMin:n-c,xMax:r+c,yMin:s-l,yMax:a+l},this.updateWorld(this.worldBounds)}};function xt(i,t=30){let e=i.getBoundingClientRect();return{x:t,y:t,width:e.width-2*t,height:e.height-2*t}}function X(i){if(i.data?.length){let t=i.data.map(n=>n.x),e=i.data.map(n=>n.y);return{xMin:Math.min(...t),xMax:Math.max(...t),yMin:Math.min(...e),yMax:Math.max(...e)}}else if(i.points?.length){let t=i.points.map(n=>n.x),e=i.points.map(n=>n.y);return{xMin:Math.min(...t),xMax:Math.max(...t),yMin:Math.min(...e),yMax:Math.max(...e)}}else if(i.pos){let t=i.pos.x,e=i.pos.x,n=i.pos.y,r=i.pos.y;return typeof i.radius=="number"&&(t=i.pos.x-i.radius,e=i.pos.x+i.radius,n=i.pos.y-i.radius,r=i.pos.y+i.radius),{xMin:t,xMax:e,yMin:n,yMax:r}}else if(i.p1&&i.p2){let t=[i.p1.x,i.p2.x],e=[i.p1.y,i.p2.y];return{xMin:Math.min(...t),xMax:Math.max(...t),yMin:Math.min(...e),yMax:Math.max(...e)}}else if(i.grid)return{xMin:0,xMax:i.grid[0].length,yMin:0,yMax:i.grid.length};return null}function wt(i,t,e=.05){let n=t.map(X).filter(f=>f!=null);if(!n.length)return;let r=1/0,s=-1/0,a=1/0,o=-1/0;n.forEach(f=>{r=Math.min(r,f.xMin),s=Math.max(s,f.xMax),a=Math.min(a,f.yMin),o=Math.max(o,f.yMax)}),t.forEach(f=>{f.pos&&f.radius===1&&(r=Math.min(r,f.pos.x-f.radius),s=Math.max(s,f.pos.x+f.radius),a=Math.min(a,f.pos.y-f.radius),o=Math.max(o,f.pos.y+f.radius))});let x=s-r,c=o-a,l=Math.max(x,c),u=(s+r)/2,h=(o+a)/2;r=u-l/2,s=u+l/2,a=h-l/2,o=h+l/2;let m=(s-r)*e,b=(o-a)*e;i.worldBounds={xMin:r-m,xMax:s+m,yMin:a-b,yMax:o+b}}var k=Object.freeze({black:[0,0,0,255],white:[255,255,255,255],red:[255,0,0,255],green:[0,255,0,255],blue:[0,0,255,255],yellow:[255,255,0,255],cyan:[0,255,255,255],magenta:[255,0,255,255],gray:[128,128,128,255],grey:[128,128,128,255],orange:[255,165,0,255],transparent:[0,0,0,0]});function F(i){return i<0?0:i>255?255:i|0}function ft(i){return i<0?0:i>1?1:i}function v(i){if(Array.isArray(i)){let[e,n,r,s=255]=i;return[e|0,n|0,r|0,s|0]}if(typeof i!="string")return null;let t=i.trim().toLowerCase();if(t in k)return k[t];if(t[0]==="#"){let e=t.slice(1),n=e.length,r=s=>parseInt(e[s]+(n<6?e[s]:e[s+1]||e[s]),16);switch(n){case 3:return[r(0),r(1),r(2),255];case 4:return[r(0),r(1),r(2),r(3)];case 6:return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16),255];case 8:return[parseInt(e.slice(0,2),16),parseInt(e.slice(2,4),16),parseInt(e.slice(4,6),16),parseInt(e.slice(6,8),16)];default:return null}}if(t.startsWith("rgb")){let e=t.match(/\d+\.?\d*/g);if(!e||e.length!==3&&e.length!==4)return null;let n=F(+e[0]),r=F(+e[1]),s=F(+e[2]),a=e[3]==null?255:ft(+e[3])*255+.5|0;return[n,r,s,a]}return null}function N(i,t,e,n){return n<<24|e<<16|t<<8|i}function Mt(i){return[i&255,i>>>8&255,i>>>16&255,i>>>24&255]}function I(i,t,e,n,r,s,a,o){let x=n/255,c=o/255,l=c+x*(1-c);if(l<=0)return[0,0,0,0];let u=1-c,h=(r*c+i*x*u)/l,m=(s*c+t*x*u)/l,b=(a*c+e*x*u)/l;return[h,m,b,l*255]}function vt(i){if(Array.isArray(i)){let t=i;return[t[0]|0,t[1]|0,t[2]|0,(t[3]??255)|0]}else return v(i)||k.white}function W(i,t,e,n){let r=n,s=Math.round(t.x),a=Math.round(t.y),o=Math.round(e.x),x=Math.round(e.y),c=Math.abs(o-s),l=Math.abs(x-a),u=s<o?1:-1,h=a<x?1:-1,m=c-l,b=i.buffer;for(;b.putPixelBlend(s,a,r),!(s===o&&a===x);){let f=m<<1;f>-l&&(m-=l,s+=u),f<c&&(m+=c,a+=h)}}function K(i,t,e,{type:n="circle",size:r=3}={}){if(n==="circle")A(i,t,r,e);else if(n==="cross")W(i,new d(t.x-r,t.y),new d(t.x+r,t.y),e),W(i,new d(t.x,t.y-r),new d(t.x,t.y+r),e);else if(n==="square"){let s=r|0,a=[new d(t.x-s,t.y-s),new d(t.x+s,t.y-s),new d(t.x+s,t.y+s),new d(t.x-s,t.y+s)];z(i,a,e,1)}}function z(i,t,e,n=1){for(let r=0;r<t.length;r++){let s=t[r],a=t[(r+1)%t.length];if(n<=1){W(i,s,a,e);continue}let o=a.sub(s),x=o.len()||1,c=o.scale(1/x),l=new d(-c.y,c.x),u=n/2|0;for(let h=-u;h<=u;h++){let m=l.scale(h);W(i,s.add(m),a.add(m),e)}}}function A(i,t,e,n){let r=e*e,s=Math.max(0,Math.floor(t.x)|0),a=Math.min(i.buffer.width-1,Math.ceil(t.x)|0),o=Math.max(0,Math.floor(t.y)|0),x=Math.min(i.buffer.height-1,Math.ceil(t.y)|0),c=i.buffer.pixels,l=i.buffer.width;for(let u=o;u<=x;u++){let h=u-t.y,m=h*h,b=(u*l+s|0)*4;for(let f=s;f<=a;f++,b+=4){let p=f-t.x;if(p*p+m<=r){let w=c[b],y=c[b+1],g=c[b+2],V=c[b+3],[B,D,S,L]=I(w,y,g,V,n[0],n[1],n[2],n[3]);c[b]=B+.5|0,c[b+1]=D+.5|0,c[b+2]=S+.5|0,c[b+3]=L+.5|0}}}}function R(i,t,e){let n=t?.length|0;if(n<3)return;let r=i.buffer.height|0,s=i.buffer.width|0,a=1/0,o=-1/0,x=[];for(let l=0;l<n;l++){let u=t[l],h=t[(l+1)%n],m=u.x,b=u.y,f=h.x,p=h.y;if(b===p)continue;let w=Math.min(b,p),y=Math.max(b,p),g=b<p?m:f,V=(f-m)/(p-b);x.push({ymin:w,ymax:y,x:g,invSlope:V}),w<a&&(a=w),y>o&&(o=y)}a=Math.max(0,Math.floor(a)|0),o=Math.min(r-1,Math.ceil(o)|0);let c=i.buffer.pixels;for(let l=a;l<=o;l++){let u=[];for(let h of x)l>=h.ymin&&l<h.ymax&&u.push(h.x+(l-h.ymin)*h.invSlope);if(u.length){u.sort((h,m)=>h-m);for(let h=0;h<u.length;h+=2){let m=Math.max(0,Math.floor(u[h])|0),b=Math.min(s-1,Math.ceil(u[h+1])|0),f=(l*s+m|0)*4;for(let p=m;p<=b;p++,f+=4){let w=c[f],y=c[f+1],g=c[f+2],V=c[f+3],[B,D,S,L]=I(w,y,g,V,e[0],e[1],e[2],e[3]);c[f]=B+.5|0,c[f+1]=D+.5|0,c[f+2]=S+.5|0,c[f+3]=L+.5|0}}}}}var C=(i,t,e,n,r=1)=>z(i,[t,e],n,r);function J(i,t,e,n,r=1,s=32){let a=[];for(let o=0;o<s;o++){let x=o/s*Math.PI*2;a.push(new d(t.x+e*Math.cos(x),t.y+e*Math.sin(x)))}z(i,a,n,r)}function Q(i){if(!isFinite(i)||i<=0)return 0;let t=Math.abs(i);return t>=1?0:Math.min(6,Math.ceil(-Math.log10(t)))}function _(i,t){let e=+i.toFixed(t);return(Math.abs(e)<1e-12?0:e).toFixed(t)}var tt=class{constructor(t,e={}){this.vp=t;this.showGrid=e.showGrid!==!1,this.showAxes=e.showAxes!==!1,this.showTicks=e.showTicks!==!1,this.drawBorder=e.drawBorder||!1,this.axisAtZero=e.axisAtZero!==!1,this.gridColor=v(e.gridColor||"#2a2a2a"),this.axisColor=v(e.axisColor||"#888"),this.borderColor=v(e.borderColor||"#555"),this.tickSizePx=e.tickSizePx??6,this.tickThickness=e.tickThickness??1,this.axisThickness=e.axisThickness??2,this.font=e.font||"12px sans-serif",this.textColor=e.textColor||"#fff",this.margin=e.margin??30,this.labelOffset=e.labelOffset??10,this.numTicksX=e.numTicksX??5,this.numTicksY=e.numTicksY??5,this.autoScale=e.autoScale??!1,this.axisXPos=0,this.axisYPos=0}setAxisPosition(t,e){this.axisXPos=t,this.axisYPos=e}setLabelStyle(t,e,n){this.font=t,this.textColor=e,n!==void 0&&(this.labelOffset=n)}computeTicks(t,e,n){if(!isFinite(t)||!isFinite(e)||n<=0)return[];let r=e-t;if(r===0)return[t];let s=r/n,a=Math.pow(10,Math.floor(Math.log10(s))),o=Math.ceil(s/a)*a,x=Math.ceil(t/o)*o,c=[];for(let l=x;l<=e+1e-12;l+=o)c.push(+l.toFixed(6));return c}autoScaleTicks(t){if(!this.autoScale)return;let e=Math.abs(t.xMax-t.xMin),n=Math.abs(t.yMax-t.yMin);e>0&&(this.numTicksX=Math.max(2,Math.floor(e/50))),n>0&&(this.numTicksY=Math.max(2,Math.floor(n/50)))}autoScaleToDrawables(t,e=.05){let n=t.map(X).filter(m=>m!=null);if(!n.length)return;let r=Math.min(...n.map(m=>m.xMin)),s=Math.max(...n.map(m=>m.xMax)),a=Math.min(...n.map(m=>m.yMin)),o=Math.max(...n.map(m=>m.yMax)),x=s-r||1,c=o-a||1,l=e<1?x*e:e,u=e<1?c*e:e,h={xMin:r-l,xMax:s+l,yMin:a-u,yMax:o+u};this.vp.fitToBounds([h],0),this.vp.updateWorld(h)}draw(t){let e=this.vp.viewport,n=this.vp.worldBounds;if(!e||!n)return;this.autoScale&&this.autoScaleTicks(n);let r=this.computeTicks(n.xMin,n.xMax,this.numTicksX),s=this.computeTicks(n.yMin,n.yMax,this.numTicksY),a=Q(r.length>1?Math.abs(r[1]-r[0]):1),o=Q(s.length>1?Math.abs(s[1]-s[0]):1),x=this.axisAtZero&&n.yMin<=0&&n.yMax>=0?this.axisXPos:n.yMin,c=this.axisAtZero&&n.xMin<=0&&n.xMax>=0?this.axisYPos:n.xMin;if(this.showGrid){for(let l of r){let u=this.vp.worldToCanvas(l,n.yMin),h=this.vp.worldToCanvas(l,n.yMax);C(t,u,h,this.gridColor,1)}for(let l of s){let u=this.vp.worldToCanvas(n.xMin,l),h=this.vp.worldToCanvas(n.xMax,l);C(t,u,h,this.gridColor,1)}}if(this.showAxes){let l=this.vp.worldToCanvas(n.xMin,x),u=this.vp.worldToCanvas(n.xMax,x),h=this.vp.worldToCanvas(c,n.yMin),m=this.vp.worldToCanvas(c,n.yMax);C(t,l,u,this.axisColor,this.axisThickness),C(t,h,m,this.axisColor,this.axisThickness)}if(this.showTicks&&this.tickSizePx>0){let l=this.tickSizePx;for(let u of r){let h=this.vp.worldToCanvas(u,x);C(t,new d(h.x,h.y-l/2),new d(h.x,h.y+l/2),this.axisColor,this.tickThickness),t.drawText(_(u,a),new d(h.x,h.y+this.labelOffset),this.textColor,this.font,"center","top")}for(let u of s){let h=this.vp.worldToCanvas(c,u);C(t,new d(h.x-l/2,h.y),new d(h.x+l/2,h.y),this.axisColor,this.tickThickness),t.drawText(_(u,o),new d(h.x-this.labelOffset,h.y),this.textColor,this.font,"right","middle")}}}};var M=class i{constructor(t=1,e=0,n=0,r=1,s=0,a=0){this.a=t;this.b=e;this.c=n;this.d=r;this.e=s;this.f=a}static identity(){return new i}static translation(t,e){return new i(1,0,0,1,t,e)}static scale(t,e=t){return new i(t,0,0,e,0,0)}static rotation(t){let e=Math.cos(t),n=Math.sin(t);return new i(e,n,-n,e,0,0)}static fromCanvasTransform(t,e,n,r,s,a){return new i(t,e,n,r,s,a)}multiply(t){return new i(this.a*t.a+this.c*t.b,this.b*t.a+this.d*t.b,this.a*t.c+this.c*t.d,this.b*t.c+this.d*t.d,this.a*t.e+this.c*t.f+this.e,this.b*t.e+this.d*t.f+this.f)}transformV2(t){return new d(this.a*t.x+this.c*t.y+this.e,this.b*t.x+this.d*t.y+this.f)}static around(t,e){return i.translation(t.x,t.y).multiply(e).multiply(i.translation(-t.x,-t.y))}};var T=class{constructor(t="white",e=!1,n=null,r=M.identity(),s){this.color=t;this.fill=e;this.fillColor=n;this.transform=r;this.fillColor||(this.fillColor=t),this.legend=s}parseColorSafe(t){return[...v(t)??[255,255,255,255]]}},et=class extends T{constructor(e,n={}){super(n.color??"red",n.fill??!1,n.fillColor??"rgba(255,0,0,0.3)",M.identity(),n.legend);this.data=e;this.baselineY=n.baselineY??0}draw(e,n){if(!this.data?.length)return;let r=n.worldToCanvas(this.data[0].x,this.data[0].y),s=this.parseColorSafe(this.color);for(let c=1;c<this.data.length;c++){let l=n.worldToCanvas(this.data[c].x,this.data[c].y);C(e,r,l,s),r=l}if(!this.fill)return;let a=this.data.map(c=>n.worldToCanvas(c.x,c.y)),o=this.data[this.data.length-1],x=this.data[0];a.push(n.worldToCanvas(o.x,this.baselineY)),a.push(n.worldToCanvas(x.x,this.baselineY)),R(e,a,this.parseColorSafe(this.fillColor))}},nt=class extends T{constructor(e=new d(0,0),n=1,r={}){super(r.color??"white",r.fill??!1,r.fillColor??null,r.transform??M.identity(),r.legend);this.center=e;this.radius=n}draw(e,n){let r=this.transform.transformV2(this.center),s=n.worldToCanvas(r.x,r.y),a=n.scale,o=this.radius*(n.preserveAspect?a.x:(a.x+a.y)*.5);this.fill&&A(e,s,o,this.parseColorSafe(this.fillColor)),J(e,s,o,this.parseColorSafe(this.color))}},rt=class extends T{constructor(e,n,r={}){super(r.color??"yellow",!1,null,r.transform??M.identity(),r.legend);this.p1=e;this.p2=n;this.width=Math.max(1,(r.width??2)|0)}draw(e,n){let r=this.transform.transformV2(this.p1),s=this.transform.transformV2(this.p2),a=n.worldToCanvas(r.x,r.y),o=n.worldToCanvas(s.x,s.y);z(e,[a,o],this.parseColorSafe(this.color),this.width)}},st=class extends T{constructor(e,n={}){super(n.color??"white",!1,null,n.transform??M.identity(),n.legend);this.pos=e;this.type=n.type??"circle",this.size=n.size??3}draw(e,n){let r=this.transform.transformV2(this.pos),s=n.worldToCanvas(r.x,r.y);K(e,s,this.parseColorSafe(this.color),{type:this.type,size:this.size})}},it=class extends T{constructor(t,e,n,r={}){super(r.color??"yellow",r.fill??!0,r.fillColor??"rgba(255,255,0,0.5)",r.transform??M.identity(),r.legend),this.points=[t,e,n]}draw(t,e){let r=this.points.map(s=>this.transform.transformV2(s)).map(s=>e.worldToCanvas(s.x,s.y));this.fill&&R(t,r,this.parseColorSafe(this.fillColor));for(let s=0;s<3;s++)C(t,r[s],r[(s+1)%3],this.parseColorSafe(this.color))}},at=class extends T{constructor(e,n,r={}){super(r.color??"white",!1,null,r.transform??M.identity(),r.legend);this.text=e;this.pos=n;this.font=r.font??"14px sans-serif",this.align=r.align??"left",this.baseline=r.baseline??"alphabetic"}draw(e,n){let r=this.transform.transformV2(this.pos),s=n.worldToCanvas(r.x,r.y);e.drawText(this.text,s,this.color,this.font,this.align,this.baseline)}},ot=class extends T{constructor(e,n,r={}){super(r.color??"white",!1,null,r.transform??M.identity(),r.legend);this.text=e;this.pos=n;this.mode=r.mode??"world",this.font=r.font??"14px sans-serif",this.align=r.align??"left",this.baseline=r.baseline??"alphabetic"}draw(e,n){let r=this.mode==="canvas"?this.pos:n.worldToCanvas(this.transform.transformV2(this.pos).x,this.transform.transformV2(this.pos).y);e.drawText(this.text,r,this.color,this.font,this.align,this.baseline)}};var G=class{constructor(t,e){this.width=0;this.height=0;this.imageData=new ImageData(Math.max(1,t|0),Math.max(1,e|0)),this.pixels=this.imageData.data,this.px32=new Uint32Array(this.pixels.buffer),this.width=this.imageData.width,this.height=this.imageData.height}resize(t,e){this.imageData=new ImageData(Math.max(1,t|0),Math.max(1,e|0)),this.pixels=this.imageData.data,this.px32=new Uint32Array(this.pixels.buffer),this.width=this.imageData.width,this.height=this.imageData.height}clear(t="#131313"){let e=v(t)||k.black,n=N(e[0],e[1],e[2],e[3]);this.px32.fill(n)}index(t,e){return(e*this.width+t|0)*4}putPixel(t,e,n){if(t>>>0>=this.width>>>0||e>>>0>=this.height>>>0)return;let r=this.index(t|0,e|0),s=n;this.pixels[r]=s[0],this.pixels[r+1]=s[1],this.pixels[r+2]=s[2],this.pixels[r+3]=s[3]}putPixelBlend(t,e,n){if(t>>>0>=this.width>>>0||e>>>0>=this.height>>>0)return;let r=this.index(t|0,e|0),s=this.pixels[r],a=this.pixels[r+1],o=this.pixels[r+2],x=this.pixels[r+3],[c,l,u,h]=I(s,a,o,x,n[0],n[1],n[2],n[3]);this.pixels[r]=c+.5|0,this.pixels[r+1]=l+.5|0,this.pixels[r+2]=u+.5|0,this.pixels[r+3]=h+.5|0}blit(t,e,n){let r=t.width|0,s=t.height|0,a=t.data,o=this.width,x=this.height;e|=0,n|=0;let c=Math.max(0,e),l=Math.max(0,n),u=Math.min(o,e+r),h=Math.min(x,n+s);for(let m=l-n;m<h-n;m++){let f=(n+m)*o;for(let p=c-e;p<u-e;p++){let w=e+p,y=(m*r+p)*4,g=(f+w)*4,V=this.pixels[g],B=this.pixels[g+1],D=this.pixels[g+2],S=this.pixels[g+3],L=a[y],ut=a[y+1],mt=a[y+2],$=a[y+3],P=$/255,Y=1-P;this.pixels[g]=L*P+V*Y+.5|0,this.pixels[g+1]=ut*P+B*Y+.5|0,this.pixels[g+2]=mt*P+D*Y+.5|0,this.pixels[g+3]=$*P+S*Y+.5|0}}}};var O=class{constructor(t=256){this.capacity=t;this.map=new Map;this.capacity|=0}get(t){let e=this.map.get(t);return e&&(this.map.delete(t),this.map.set(t,e)),e??null}set(t,e){for(this.map.has(t)&&this.map.delete(t),this.map.set(t,e);this.map.size>this.capacity;){let n=this.map.keys().next().value;n!==void 0&&this.map.delete(n)}}clear(){this.map.clear()}};var H=class{constructor(t){this.canvas=t;this.renderables=[];this.ctx=t.getContext("2d"),this.size=new d(t.width,t.height),this.buffer=new G(this.size.x,this.size.y),this.textCanvas=document.createElement("canvas"),this.textCtx=this.textCanvas.getContext("2d"),this.textCache=new O(512)}addRenderable(t){this.renderables.push(t)}clear(t="#131313"){this.buffer.clear(t)}putPixel(t,e){this.buffer.putPixel(t.x|0,t.y|0,e)}putPixelBlend(t,e){this.buffer.putPixelBlend(t.x|0,t.y|0,e)}blitImageData(t,e,n){this.buffer.blit(t,e,n)}render(){this.ctx.putImageData(this.buffer.imageData,0,0)}renderAll(){this.clear(),this.renderables.forEach(t=>t.draw(this)),this.render()}drawText(t,e,n="#fff",r="12px sans-serif",s="left",a="alphabetic"){let o=`${t}|${r}|${n}`,x=this.textCache.get(o);if(!x){let m=this.textCtx;m.font=r;let b=m.measureText(t),f=Math.ceil(b.width+4),p=Math.ceil((b.actualBoundingBoxAscent||10)+(b.actualBoundingBoxDescent||4)+4);(this.textCanvas.width<f||this.textCanvas.height<p)&&(this.textCanvas.width=f,this.textCanvas.height=p),m.clearRect(0,0,f,p),m.font=r,m.fillStyle=n,m.textBaseline="top",m.textAlign="left",m.fillText(t,2,2),x=m.getImageData(0,0,f,p),this.textCache.set(o,x)}let{width:c,height:l}=x,u=0,h=0;s==="center"?u=-c/2:(s==="right"||s==="end")&&(u=-c),a==="middle"?h=-l/2:(a==="bottom"||a==="ideographic"||a==="alphabetic")&&(h=-l),this.blitImageData(x,e.x+u+.5|0,e.y+h+.5|0)}},q=class{constructor(t,e={}){this.containerDiv=t;this.canvas=document.createElement("canvas"),t.appendChild(this.canvas),Object.assign(this.canvas.style,{width:"100%",height:"100%",display:"block",background:e.background||"black"}),this.app=new H(this.canvas),this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){let t=this.containerDiv.getBoundingClientRect(),e=window.devicePixelRatio||1,n=Math.max(1,t.width|0),r=Math.max(1,t.height|0);this.canvas.width=n*e,this.canvas.height=r*e,this.app.ctx.setTransform(1,0,0,1,0,0),this.app.ctx.scale(e,e),this.app.size=new d(n,r),this.app.buffer.resize(n,r)}clear(){this.app.clear()}render(){this.app.render()}};function dt(i,t,e){return i.rotate(e,t)}function Qt(i,t,e){i.points=i.points.map(n=>dt(n,t,e))}function _t(i,t,e){let n=M.around(t,M.scale(Math.cos(e),1));i.points=i.points.map(r=>n.transformV2(r))}function bt(i,t,e){return M.around(t,M.scale(Math.cos(e),1)).transformV2(i)}var Z=class i{static findX(t){let e=[];for(let n=1;n<t.length;n++){let r=t[n-1].y,s=t[n].y;if(r===0)e.push(t[n-1].x);else if(r*s<0){let a=t[n-1].x,o=t[n].x;e.push(a+-r/(s-r)*(o-a))}}return e}static drawX(t,e,n,r="yellow"){let s=v(r)||k.yellow,a=i.findX(n);for(let o of a){let x=e.worldToCanvas(o,0);A(t,new d(x.x+.5|0,x.y+.5|0),5,s)}}};var lt=class{constructor(){this.layers=[]}add(t,e="default"){let n=Array.isArray(t)?t:[t],r=this.layers.find(s=>s.name===e);return r||(r={name:e,drawables:[]},this.layers.push(r),this.sortLayers()),r.drawables.push(...n),this}remove(t){for(let e of this.layers)e.drawables=e.drawables.filter(n=>n!==t);return this}clear(t){if(t){let e=this.layers.find(n=>n.name===t);e&&(e.drawables.length=0)}else this.layers.length=0;return this}draw(t,e){for(let r of this.layers)if(r.name!=="debug")for(let s of r.drawables)s.visible!==!1&&s.draw(t,e);let n=this.layers.find(r=>r.name==="debug");if(n)for(let r of n.drawables)r.visible!==!1&&(r.ignoreViewport?r.draw(t,void 0):r.draw(t,e))}collectDrawables(){let t=[];for(let e of this.layers)t.push(...e.drawables);return t}collectLegend(){let t=[];for(let e of this.layers)for(let n of e.drawables){let r=n.legend;r&&t.push({label:r.label,color:r.color??n.color??"#fff",symbol:r.symbol??"line"})}return t}sortLayers(){this.layers.sort((t,e)=>t.name==="debug"?1:e.name==="debug"?-1:t.name.localeCompare(e.name))}},ct=class{constructor(){this.entries=[];this._rafId=null}add(t,e,n,r){return this.entries.push({host:t,scene:e,vp:n,id:r}),this}init(){this.entries.forEach(({host:t,vp:e})=>{if(t.resize?.(),e?.updateWorld)try{e.updateWorld(e.worldBounds)}catch(n){console.warn("Could not update viewport:",n)}})}resizeAll(){this.entries.forEach(({host:t,vp:e})=>{if(t.resize?.(),e?.updateWorld)try{e.updateWorld(e.worldBounds)}catch{}})}renderAll(){this.entries.forEach(({host:t,scene:e,vp:n})=>{t.clear?.(),e.draw(t.app,n),t.render?.()})}startLoop(t){if(this._rafId!=null)return;let e=n=>{t?.(n),this.renderAll(),this._rafId=requestAnimationFrame(e)};this._rafId=requestAnimationFrame(e)}stopLoop(){this._rafId!=null&&(cancelAnimationFrame(this._rafId),this._rafId=null)}get(t){return this.entries.find(e=>e.id===t)}attachWindowResize(t=120){let e=null;window.addEventListener("resize",()=>{e!=null&&window.clearTimeout(e),e=window.setTimeout(()=>{this.resizeAll(),e=null},t)})}};var j=class{constructor(t,e,n="#fff",r="16px monospace"){this.text=t;this.pos=e;this.color=n;this.font=r}draw(t,e=2){let n=new d(this.pos.x+e,this.pos.y+e);t.drawText(this.text,n,this.color,this.font,"left","top")}},ht=class i extends T{constructor(e=new d(10,10),n=2){super("white",!1,null);this.elements=[];this.lastTime=performance.now();this.visible=!0;this.ignoreViewport=!0;this.margin=n;let r=new j("FPS: 0",e);this.elements.push(r),i.registry.push(this)}static{this.registry=[]}update(){let e=performance.now(),n=e-this.lastTime,r=n>0?Math.round(1e3/n):0;this.elements[0].text=`FPS: ${r}`,this.lastTime=e}draw(e){if(this.visible)for(let n of this.elements)n.draw(e,this.margin)}static updateAll(){for(let e of i.registry)e.update()}};var U=class extends T{constructor(e,n={}){super("white",!1,null);this.items=e;this.options=n}estimateTextWidth(e,n){let r=/(\d+)\s*px/.exec(n),s=r?parseInt(r[1],10):12;return Math.max(8,Math.round(e.length*s*.6))}draw(e,n){let r={anchor:this.options.anchor??"ne",padding:this.options.padding??8,gap:this.options.gap??6,swatchSize:this.options.swatchSize??14,font:this.options.font??"12px sans-serif",textColor:this.options.textColor??"#fff",background:this.options.background===void 0?"rgba(0,0,0,0.35)":this.options.background,boxOffset:this.options.boxOffset??new d(0,0),maxWidthPx:this.options.maxWidthPx??0};if(!this.items?.length)return;let s=n.viewport,a=r.padding,o=r.swatchSize,x=Math.max(o,12)+r.gap,c=0;for(let w of this.items)c=Math.max(c,this.estimateTextWidth(w.label,r.font));let l=o+6+c,u=(r.maxWidthPx&&r.maxWidthPx>l?r.maxWidthPx:l)+a*2,h=this.items.length*x-r.gap+a*2,m=0,b=0;switch(r.anchor){case"ne":m=s.x+s.width-u-4,b=s.y+4;break;case"nw":m=s.x+4,b=s.y+4;break;case"se":m=s.x+s.width-u-4,b=s.y+s.height-h-4;break;case"sw":m=s.x+4,b=s.y+s.height-h-4;break}if(m+=r.boxOffset.x,b+=r.boxOffset.y,r.background){let w=v(r.background)||[0,0,0,128],y=[new d(m,b),new d(m+u,b),new d(m+u,b+h),new d(m,b+h)];R(e,y,w)}let f=m+a,p=b+a+x/2;for(let w of this.items){let y=v(w.color)||[255,255,255,255],g=w.symbol??"line";if(g==="marker")A(e,new d(Math.round(f+o/2),Math.round(p)),Math.max(3,Math.floor(o/3)),y);else if(g==="area"){let V=[new d(f,p-o/2+3),new d(f+o,p-o/2+3),new d(f+o,p+o/2-3),new d(f,p+o/2-3)];R(e,V,y),C(e,new d(f,p-o/2),new d(f+o,p-o/2),y,1)}else C(e,new d(f,p),new d(f+o,p),y,2);e.drawText(w.label,new d(f+o+6,p),r.textColor,r.font,"left","middle"),p+=x}}};export{H as CanvasRenderer,ht as DebugUI,T as Drawable,nt as DrawableCircle,et as DrawableFunction,ot as DrawableLabel,U as DrawableLegend,rt as DrawableLine,st as DrawablePoint,at as DrawableText,it as DrawableTriangle,q as DynamicCanvasRenderer,tt as Graph,Z as Intercepts,k as NAMED,G as PixelBuffer,lt as Scene,ct as SceneManager,O as TextCache,M as Transform2D,d as V2,E as ViewportManager,wt as autoScaleViewport,I as blendRGBA,ft as clamp01,F as clamp255,J as drawCircleOutline,C as drawLine,A as fillCircle,R as fillPolygon,xt as getDivViewport,X as getDrawableBounds,N as packABGR,v as parseColor,bt as projectYRotation,W as rawLine,K as rawPoint,dt as rotatePoint,Qt as rotateTriangleAroundCenter,_t as rotateTriangleVertical,z as strokeShape,vt as toColor,Mt as unpackABGR};
//# sourceMappingURL=canvasLib.js.map
